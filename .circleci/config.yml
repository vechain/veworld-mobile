version: 2.1
jobs:
  build-and-test:
    docker:
      - image: "cimg/node:18.12.1"
    parallelism: 4
    steps:
      - checkout
      - restore_cache:
          key: 'yarn-v2-{{ checksum "yarn.lock" }}'
      - restore_cache:
          key: 'node-v2-{{ checksum "package.json" }}'
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile
      - save_cache:
          key: 'yarn-v2-{{ checksum "yarn.lock" }}'
          paths:
            - ~/.cache/yarn
      - save_cache:
          key: 'node-v2-{{ checksum "package.json" }}'
          paths:
            - node_modules
      - run:
          name: Lint & Format Check
          command: "yarn lint && yarn format:check"
      - run:
          name: Install JUnit coverage reporter
          command: yarn add --dev jest-junit
      - run: mkdir ~/junit
      - run:
          name: Run Unit Tests
          command: >
            TEST=$(circleci tests glob "src/**/*.spec.ts" "src/**/*.spec.tsx"
            "src/**/*.test.ts" "src/**/*.test.tsx" | circleci tests split
            --split-by=timings)

            xargs npx nyc
            --temp-dir=./.nyc_output_temp/$CIRCLE_JOB-$CIRCLE_NODE_INDEX/nyc_output

            yarn test --forceExit $TEST --ci --runInBand --reporters=default 
            --reporters=jest-junit
          environment:
            NODE_OPTIONS: "--max_old_space_size=4096"
      - persist_to_workspace:
          root: .
          paths:
            - .nyc_output_temp/*
      - run:
          command: cp junit.xml ~/junit/
          when: always
      - store_test_results:
          path: ~/junit
      - store_artifacts:
          path: ~/coverage

  test-coverage:
    docker:
      - image: "cimg/node:18.12.1"
    steps:
      - run:
          name: Merge coverage output
          command: node merge-coverage.js
      - run:
          name: Check code coverage
          command: >-
            npx nyc report --reporter=lcov --reporter=text-summary
            --check-coverage

workflows:
  build-and-test:
    jobs:
      - build-and-test
  test-coverage:
    jobs:
      - test-coverage
