name: Run E2E Tests

on:
    workflow_call:
        inputs:
            platform:
                description: 'The platform to run the tests on'
                required: true
                type: string
                default: 'ios'
    
    push:
        branches:
            - chore/android-gha

env:
    IOS_CONFIGURATION: ios.sim.debug_xcode_14.2
    ANDROID_CONFIGURATION: android.emu.debug.31
    ANDROID_AVD_NAME: Pixel_6_Pro_API_31
    TEST_TIMEOUT: ${{ 100 }}
    BUILD_TIMEOUT: ${{ 60 }}
    CUCUMBER_PARALLEL: ${{ 2 }}

jobs:
    run-e2e-tests:
        runs-on: macos-latest-xl
        steps:

            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version-file: .nvmrc
                  cache: "yarn"
            
            - name: Install & Patch packages
              run: yarn install --frozen-lockfile --network-timeout 300000

            # Setup Java for Android
            - name: Setup Java for Android
              if: ${{ github.event.inputs.platform == 'android' }}
              uses: actions/setup-java@v3
              with:
                  cache: gradle
                  distribution: "zulu"
                  java-version: "11"
        
            # Install Homebrew and applesimutils for iOS
            - name: Install macOS dependencies for iOS
              if: ${{ github.event.inputs.platform == 'ios' }}
              run: |
                brew tap wix/brew
                brew install applesimutils
              env:
                HOMEBREW_NO_AUTO_UPDATE: 1
                HOMEBREW_NO_INSTALL_CLEANUP: 1
         
            # Setup Ruby for iOS
            - name: Setup Ruby for iOS
              if: ${{ github.event.inputs.platform == 'ios' }}
              uses: ruby/setup-ruby@v1
              with:
                bundler-cache: true

            # Install Detox CLI
            - name: Setup Detox
              run: yarn detox clean-framework-cache && yarn detox build-framework-cache && yarn detox reset-lock-file

            # Install sentry properties for android
            - name: Sentry properties for Android
              if: ${{ github.event.inputs.platform == 'android' }}
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_SENTRY_PROPERTIES }}
                filename: "sentry.properties"
                is-executable: false
                working-directory: "./android"
        
            # Install sentry properties for iOS
            - name: Sentry properties for iOS
              if: ${{ github.event.inputs.platform == 'ios' }}
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.SENTRY_PROPERTIES }}
                filename: "sentry.properties"
                is-executable: false
                working-directory: "./ios"
        
            # Install keystore properties for Android
            - name: Keystore properties for Android
              if: ${{ github.event.inputs.platform == 'android' }}
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_KEYSTORE_PROPERTIES }}
                filename: "keystore.properties"
                is-executable: false
                working-directory: "./android"
        
            # Start Metro Bundler
            - name: Start Metro Bundler
              run: REACT_APP_UI_LOG=false yarn react-native start &> metro-bundler.log &

            # Build iOS app
            - name: Detox build iOS
              if: ${{ github.event.inputs.platform == 'ios' }}
              id: build_app_ios
              timeout-minutes: ${{ env.TEST_TIMEOUT }}
              run: SKIP_SENTRY=true yarn detox build --configuration ${{ env.IOS_CONFIGURATION }}

            # Build Android app
            - name: Detox build Android
              if: ${{ github.event.inputs.platform == 'android' }}
              id: build_app_android
              run: yarn detox build --configuration ${{ env.ANDROID_CONFIGURATION }}

            # Run Android tests
            - name: Detox test Android
              if: ${{ github.event.inputs.platform == 'android' }}
              id: test_android
              uses: reactivecircus/android-emulator-runner@v2
              timeout-minutes: ${{ env.TEST_TIMEOUT }}
              with:
                  api-level: 31
                  arch: x86_64
                  force-avd-creation: false
                  disable-animations: true
                  avd-name: ${{ env.ANDROID_AVD_NAME }}
                  script: yarn detox test --configuration ${{ env.ANDROID_CONFIGURATION }} --headless --record-logs all --take-screenshots all --tags "not @broken and not @notAndroid" --parallel ${{ env.CUCUMBER_PARALLEL }} --publish &> cucumber.log

            # Run iOS tests
            - name: Detox test iOS
              id: test_app_ios
              timeout-minutes: ${{ env.TEST_TIMEOUT }}
              run: yarn detox test --configuration ${{ env.IOS_CONFIGURATION }} --cleanup --headless --record-logs all --take-screenshots all --retry 1 --tags "not @broken" --parallel ${{ env.CUCUMBER_PARALLEL }} --publish &> cucumber.log

            # Upload test artifacts from Detox
            - name: Upload detox artifacts
              if: always() && (steps.test_app_ios.outcome == 'failure' || steps.test_android.outcome == 'failure')
              uses: actions/upload-artifact@v3
              with:
                name: detox-fail-artifacts
                path: artifacts

            # Upload cucumber artifacts
            - name: Upload cucumber artifacts
              if: always() && (steps.test_app_ios.outcome == 'failure' || steps.test_android.outcome == 'failure')
              uses: actions/upload-artifact@v3
              with:
                name: cucumber-fail-artifacts
                path: |
                    cucumber.log
                    cucumber-report.html
            
            # Upload Metro Bundler logs
            - name: Upload Metro Bundler logs
              if: always() && (steps.build_app_ios.outcome == 'failure' || steps.build_app_android.outcome == 'failure')
              uses: actions/upload-artifact@v2
              with:
                name: metro-bundler-logs
                path: metro-bundler.log

            # Get cucumber published url
            - name: Parse cucumber report URL
              id: parse_report_url
              if: always() && (steps.test_app_ios.outcome != 'skipped' || steps.test_android.outcome != 'skipped')
              run: |
                echo report_url=$(cat cucumber.log | grep -Eo "https://reports.cucumber.io/reports/[a-zA-Z0-9-]+") >> "$GITHUB_OUTPUT"
            
            # Post results to slack
            - name: Post to a Slack channel
              if: cancelled()
              uses: slackapi/slack-github-action@v1.24.0
              with:
                # Slack channel id, channel name, or user id to post message.
                # See also: https://api.slack.com/methods/chat.postMessage#channels
                # You can pass in multiple channels to post to by providing a comma-delimited list of channel IDs.
                channel-id: ${{ secrets.SLACK_VEWORLD_CHANNEL_ID }}
                slack-message: |
                    🖥️ Platform: *${{ github.event.inputs.platform }}*
                    🧱 Build Status - iOS Result: *${{ steps.build_app.outcome }}*
                    🚀 E2E Status - iOS Result: *${{ steps.test_app.outcome }}*
                    🌿 Branch: *${{ github.ref_name }}*
                    🔨 Commit: *${{ github.actor }}* [${{ github.sha.short }}](${{ github.event.head_commit.url }})
                    🔗 Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
                    📈 Cucumber Report: ${{ steps.parse_report_url.outputs.report_url || 'Not found.' }}
              env:
                SLACK_BOT_TOKEN: ${{ secrets.SLACK_VEWORLD_BOT_TOKEN }}