name: Release Overnight - Android & iOS

on:
    workflow_dispatch:
        inputs:
        version: 
            description: 'Version to build'
            type: string
            required: true
        build: 
            description: 'Build number'
            type: number
            required: true
    
    workflow_call:
        inputs:
        version: 
            description: 'Version to build'
            type: string
            required: true
        build: 
            description: 'Build number'
            type: number
            required: true
jobs:
    check-merged-pr:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: Check for merged PRs
              id: check_merged_prs
              run: |
                merged_prs=$(gh pr list --base main --state merged --json mergedAt --jq '.[] | select(.mergedAt > "'$(date --date="24 hours ago" --iso-8601=seconds)'") | length')
                echo "Merged PRs in the last 24 hours: $merged_prs"
                echo "::set-output name=should_release::$(if [ "$merged_prs" -gt 0 ]; then echo 'true'; else echo 'false'; fi)"
              
    build-test-scan:
        if: needs.check_merged_prs.outputs.should_release == 'true'
        needs: check-merged-pr
        uses: ./.github/workflows/install-build-test-scan.yml
        secrets: inherit
    
    release-ios:
        uses: ./.github/workflows/release-ios.yml
        needs: build-test-scan
        secrets: inherit
        with:
            version: ${{ github.event.inputs.version }}
            build: ${{ github.event.inputs.build }}
        
    release-android:
        uses: ./.github/workflows/release-android.yml
        needs: build-test-scan
        secrets: inherit
        with:
            version: ${{ github.event.inputs.version }}
            build: ${{ github.event.inputs.build }}
    
