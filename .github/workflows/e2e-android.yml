name: E2E Testing - Android

on:
    workflow_dispatch:
    
    workflow_call:

jobs:
    build-test-android:
        name: Maestro Build & Test Android Release
        runs-on: ubuntu-latest
        outputs:
          app: app/build/outputs/apk/debug

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version-file: .nvmrc
                  cache: "yarn"

            - name: Install & Patch packages
              run: yarn install --frozen-lockfile --network-timeout 300000

            - name: Setup Java
              uses: actions/setup-java@v3
              with:
                  cache: gradle
                  distribution: "zulu"
                  java-version: "11"

            # Install sentry properties
            - name: Sentry properties
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_SENTRY_PROPERTIES }}
                filename: "sentry.properties"
                is-executable: false
                working-directory: "./android"
            
            # Install keystore properties
            - name: Keystore properties
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_KEYSTORE_PROPERTIES }}
                filename: "keystore.properties"
                is-executable: false
                working-directory: "./android"
          
            - name: Build apk 
              run: |
                  cd android
                  ./gradlew assembleDebug
                  cd app/build/outputs/apk/debug
                  pwd
                  ls -la

            - name: Start Metro Bundler
              run: npx react-native start &
            
            - name: Install Maestro
              run:  MAESTRO_VERSION=1.36.0 curl -Ls 'https://get.maestro.mobile.dev' | bash

            - name: Maestro Cloud
              run: |
                $HOME/.maestro/bin/maestro cloud --apiKey ${{ secrets.MAESTRO_CLOUD_API_KEY }} android/app/build/outputs/apk/debug/app-debug.apk maestro/sendflow-id.yaml
