name: E2E Testing - Android

on:
    workflow_dispatch:
    
    workflow_call:

jobs:
    build-test-android:
        name: Maestro Build & Test Android Release
        runs-on: ubuntu-latest
        environment: android-release
        outputs:
          app: app/build/outputs/apk/release
        env:
          SENTRY_LOG_LEVEL: debug
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3
            
            - name: print env vars
              run: export

            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version-file: .nvmrc
                  cache: "yarn"

            - name: Install & Patch packages
              run: yarn install --frozen-lockfile --network-timeout 300000

            - name: Setup Java
              uses: actions/setup-java@v3
              with:
                  cache: gradle
                  distribution: "zulu"
                  java-version: "11"

            # Install sentry properties
            - name: Sentry properties
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_SENTRY_PROPERTIES }}
                filename: "sentry.properties"
                is-executable: false
                working-directory: "./android"
            # Decode key_alias 
            - name: Decode KEY_ALIAS
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_KEY_ALIAS }}
                filename: "key_alias.txt"
                is-executable: false
                working-directory: "./android"
             # Decode key_password
            - name: Decode STORE_PASSWORD
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_STORE_PASSWORD }}
                filename: "store_password.txt"
                is-executable: false
                working-directory: "./android"
            - name: Declare Envs
              run: |
                cd android
                echo "This is in the store password file"
                cat store_password.txt
                export STORE_PASSWORD="$(<store_password.txt)"
                export KEY_PASSWORD="$(<store_password.txt)"
                export KEY_ALIAS="$(<key_alias.txt)"
                export

            # Install env.default 
            - name: Sentry properties
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_SERVICE_ACCOUNT }}
                filename: "pc-api-4895632399891248889-903-c30062a54347.json"
                is-executable: false
                working-directory: "./android"
              # Install sentry properties
            - name: Sentry properties
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_FASTLANE_ENV }}
                filename: ".env.default"
                is-executable: false
                working-directory: "./android"
            # Install keystore properties
            - name: Keystore properties
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_KEYSTORE_PROPERTIES }}
                filename: "keystore.properties"
                is-executable: false
                working-directory: "./android"
            # Download Keystore
            - name: Keystore file
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_RELEASE_KEYSTORE }}
                filename: "release.keystore"
                is-executable: false
                working-directory: "./android"
            - name: Add release Dev:Demo link
              run: |
                echo "IS_CI_BUILD_ENABLED=false" > .env.local
                echo "IS_CI_BUILD_ENABLED=false" > .env.production.local
                ls -la
            - name: Build apk 
              run: |
                  pwd    
                  cd android
                  export STORE_PASSWORD="$(<store_password.txt)"
                  export KEY_PASSWORD="$(<store_password.txt)"
                  export KEY_ALIAS="$(<key_alias.txt)"
                  fastlane build_test_ci version_code:99 version_name:"9.9.9"
                  cd app/build/outputs/apk/release
                  pwd
                  ls -la

            - name: Start Metro Bundler
              run: npx react-native start &


            - name: Maestro Cloud
              uses: mobile-dev-inc/action-maestro-cloud@v1.8.1
              with:
                name: Android Test
                api-key: ${{ secrets.MAESTRO_CLOUD_API_KEY }}
                app-file: android/app/build/outputs/apk/release/app-release.apk
                android-api-level: 31