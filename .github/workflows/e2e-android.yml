name: E2E Testing - Android

on:
    workflow_dispatch:
    
    workflow_call:

jobs:
    build-test-android:
        name: Maestro Build & Test Android Release
        runs-on: macos-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version-file: .nvmrc
                  cache: "yarn"

            - name: Install & Patch packages
              run: yarn install --frozen-lockfile --network-timeout 300000

            - name: Setup Java
              uses: actions/setup-java@v3
              with:
                  cache: gradle
                  distribution: "zulu"
                  java-version: "11"

            # Install sentry properties
            - name: Sentry properties
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_SENTRY_PROPERTIES }}
                filename: "sentry.properties"
                is-executable: false
                working-directory: "./android"
            
            # Install keystore properties
            - name: Keystore properties
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_KEYSTORE_PROPERTIES }}
                filename: "keystore.properties"
                is-executable: false
                working-directory: "./android"
          
            - name: Build apk 
              run: |
                  pwd
                  ls -la
                  cd android
                  ./gradlew assembleDebug
                  cd app/build/outputs/apk/debug
                  ls -la

            - name: Get device name
              id: device-name
              run: node -e "console.log('AVD_NAME=' + require('./.detoxrc').devices.emulator_31.device.avdName)" >> $GITHUB_OUTPUT

            - name: Start Metro Bundler
              run:  REACT_APP_UI_LOG=false yarn react-native start &> metro-bundler.log &

            - name: Install Maestro
              run:  MAESTRO_VERSION=1.36.0 curl -Ls 'https://get.maestro.mobile.dev' | bash
              
            - name: Check Maestro install
              run: |
                source ~/.bashrc
                export PATH="$PATH":"$HOME/.maestro/bin"
                maestro --version
            - name: Run Maestro E2E tests
              uses: reactivecircus/android-emulator-runner@v2
              with:
                api-level: 31
                target: google_apis
                arch: x86_64
                cores: 2
                ram-size: 2048M
                force-avd-creation: false
                emulator-boot-timeout: 900 # 15min
                emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
                disable-animations: true
                pre-emulator-launch-script: |
                  echo "Running pre emulator launch script. Printing the working directory now:"
                  pwd
                script: |
                  # check memory usage
                  npx envinfo
                  
                  # verify emulator is running
                  adb devices
      
                  # Install app
                  adb install android/app/build/outputs/apk/debug/app-debug.apk || (adb kill-server && adb start-server && adb devices && adb install app-debug.apk)

                  # Run e2e
                  maestro test maestro/sendflow-id.yaml

            # Upload Metro Bundler logs
            - name: Upload Metro Bundler logs
              if: failure() || cancelled()
              uses: actions/upload-artifact@v2
              with:
                name: metro-bundler-logs
                path: metro-bundler.log
