name: E2E Testing - Android

on:
    workflow_dispatch:
    
    workflow_call:

jobs:
    build-test-android:
        name: Detox Build & Test Android Release
        runs-on: ubuntu

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3
            
            - name: Install yarn
              run: |
                sudo apt update
                curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
                echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
                sudo apt update
                sudo apt install -y yarn

            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version-file: .nvmrc
                  cache: "yarn"

            - name: Install & Patch packages
              run: yarn install

            - name: Setup Java
              uses: actions/setup-java@v3
              with:
                  cache: gradle
                  distribution: "zulu"
                  java-version: "11"

            - name: Rebuild Detox Framework
              run: yarn detox clean-framework-cache && yarn detox build-framework-cache

            # Install sentry properties
            - name: Sentry properties
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_SENTRY_PROPERTIES }}
                filename: "sentry.properties"
                is-executable: false
                working-directory: "./android"
            
            # Install keystore properties
            - name: Keystore properties
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_KEYSTORE_PROPERTIES }}
                filename: "keystore.properties"
                is-executable: false
                working-directory: "./android"

            - name: Detox build Android release
              run: yarn detox build --configuration android.emu.debug.31

            - name: Get device name
              id: device-name
              run: node -e "console.log('AVD_NAME=' + require('./.detoxrc').devices.emulator_31.device.avdName)" >> $GITHUB_OUTPUT

            - name: Start Metro Bundler
              run: yarn react-native start &

            - name: Detox test Android release
              uses: reactivecircus/android-emulator-runner@v2
              timeout-minutes: 90
              with:
                  api-level: 31
                  arch: x86_64
                  force-avd-creation: false
                  disable-animations: true
                  avd-name: ${{ steps.device-name.outputs.AVD_NAME }}
                  script: yarn detox test --configuration android.emu.debug.31 --headless --record-logs all --take-screenshots failing --tags "not @broken and not @notAndroid" --publish

            - name: Upload artifacts
              if: failure() || cancelled()
              uses: actions/upload-artifact@v3
              with:
                  name: detox-fail-artifacts
                  path: artifacts
