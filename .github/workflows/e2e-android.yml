name: E2E Testing - Android

on:
    workflow_dispatch:
    
    workflow_call:

env:
  ANDROID_CONFIGURATION: android.emu.debug.31
  ANDROID_AVD_NAME: Pixel_6_Pro_API_31


jobs:
    build-test-android:
        name: Detox Build & Test Android Release
        runs-on: macos

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3
            
            - name: Install yarn
              run: |
                sudo apt update
                curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
                echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
                sudo apt update
                sudo apt install -y yarn

            - name: Enable KVM
              run: |
                echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
                sudo udevadm control --reload-rules
                sudo udevadm trigger --name-match=kvm

            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version-file: .nvmrc
                  cache: "yarn"

            - name: Install & Patch packages
              run: yarn install

            - name: Setup Java
              uses: actions/setup-java@v3
              with:
                  cache: gradle
                  distribution: "zulu"
                  java-version: "11"

            - name: Rebuild Detox Framework
              run: yarn detox clean-framework-cache && yarn detox build-framework-cache && yarn detox reset-lock-file

            # Install sentry properties
            - name: Sentry properties
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_SENTRY_PROPERTIES }}
                filename: "sentry.properties"
                is-executable: false
                working-directory: "./android"
            
            # Install keystore properties
            - name: Keystore properties
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.ANDROID_KEYSTORE_PROPERTIES }}
                filename: "keystore.properties"
                is-executable: false
                working-directory: "./android"

            # Start Metro Bundler
            - name: Start Metro Bundler
              run: REACT_APP_UI_LOG=false yarn react-native start &> metro-bundler.log &

            # Build Android app
            - name: Android - Detox build
              id: build_app_android
              timeout-minutes: 100
              run: yarn detox build --configuration ${{ env.ANDROID_CONFIGURATION }}

             # Run Android tests
            - name: Android - Detox test
              id: test_app_android
              uses: reactivecircus/android-emulator-runner@v2
              timeout-minutes: 100
              with:
                  api-level: 31
                  arch: x86_64
                  force-avd-creation: false
                  disable-animations: true
                  avd-name: ${{ env.ANDROID_AVD_NAME }}
                  script: yarn detox test --configuration ${{ env.ANDROID_CONFIGURATION }} --headless --record-logs all --take-screenshots failing --tags "not @broken and not @notAndroid" --parallel ${{ inputs.parallel }} --publish &> cucumber.log

            - name: Upload artifacts
              if: failure() || cancelled()
              uses: actions/upload-artifact@v3
              with:
                  name: detox-fail-artifacts
                  path: artifacts
