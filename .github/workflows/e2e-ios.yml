name: E2E Testing - iOS

on:
  workflow_dispatch:

  workflow_call:

env:
    IOS_CONFIGURATION: ios.sim.debug_xcode_14.2

jobs:
    run-e2e-tests:
        runs-on: macos
        steps:

            # Checkout repository
            - name: Checkout repository
              uses: actions/checkout@v3

            # Setup Node
            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version-file: .nvmrc
                  cache: "yarn"

            - name: Install Yarn v1.22.19
              run: yarn install:all

            # Install Homebrew and applesimutils for iOS
            - name: iOS - Install macOS dependencies
              run: |
                brew tap wix/brew
                brew install applesimutils
                brew install libyaml
                brew install gmp
                yarn global add detox-cli
              env:
                HOMEBREW_NO_AUTO_UPDATE: 1
                HOMEBREW_NO_INSTALL_CLEANUP: 1

            # Setup Ruby for iOS
            - name: iOS - Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                ruby-version: 2.7.5
                bundler-cache: true
            
            - name: iOS - Install CocoaPods
              run: |
                npx install-expo-modules
                pod install --repo-update

            # Install Detox CLI
            - name: Setup Detox
              run: yarn detox clean-framework-cache && yarn detox build-framework-cache && yarn detox reset-lock-file

            
            # Install sentry properties for iOS
            - name: iOS - Sentry properties
              uses: mobiledevops/secret-to-file-action@v1
              with:
                base64-encoded-secret: ${{ secrets.SENTRY_PROPERTIES }}
                filename: "sentry.properties"
                is-executable: false
                working-directory: "./ios"
        
            # Start Metro Bundler
            - name: Start Metro Bundler
              run: REACT_APP_UI_LOG=false yarn react-native start &> metro-bundler.log &

            # Build iOS app
            - name: iOS - Detox build
              id: build_app_ios
              timeout-minutes: 100
              run: SKIP_SENTRY=true yarn detox build --configuration ${{ env.IOS_CONFIGURATION }}

             # Run iOS tests
            - name: iOS - Detox test
              id: test_app_ios
              timeout-minutes: 100
              run: yarn detox test --configuration ${{ env.IOS_CONFIGURATION }} --cleanup --headless --record-logs all --take-screenshots failing --retry 1 --tags "not @broken" --publish &> cucumber.log

            # Upload test artifacts from Detox
            - name: Upload detox artifacts
              if: always() && steps.build_app_ios.outcome == 'failure'
              uses: actions/upload-artifact@v3
              with:
                name: detox-fail-artifacts
                path: artifacts

            # Upload cucumber artifacts
            - name: Upload cucumber artifacts
              if: always() && steps.build_app_ios.outcome == 'failure'
              uses: actions/upload-artifact@v3
              with:
                name: cucumber-fail-artifacts
                path: |
                    cucumber.log
                    cucumber-report.html
            
            # Upload Metro Bundler logs
            - name: Upload Metro Bundler logs
              if: always() && steps.build_app_ios.outcome == 'failure'
              uses: actions/upload-artifact@v2
              with:
                name: metro-bundler-logs
                path: metro-bundler.log

            # Get cucumber published url
            - name: Parse cucumber report URL
              id: parse_report_url
              run: |
                echo report_url=$(cat cucumber.log | grep -Eo "https://reports.cucumber.io/reports/[a-zA-Z0-9-]+") >> "$GITHUB_OUTPUT"